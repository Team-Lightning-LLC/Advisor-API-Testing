<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DocuGen Finance</title>
<style>
:root {
  --maroon: #8B1538;
  --maroon2: #A61E1E;
  --ink: #1f2d3d;
  --muted: #6c7a89;
  --border: #e0e5ea;
  --hair: #eceff3;
  --bg: #f5f6f7;
  --card: #fff;
  --soft: #f8f9fb;
  --ok: #1f7a4d;
  --warn: #8a5a00;
  --info: #2d5699;
}

* { 
  margin: 0; 
  padding: 0; 
  box-sizing: border-box; 
}

body { 
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  font-size: 14px; 
  background: var(--bg); 
  color: var(--ink);
  line-height: 1.4;
}

/* Header */
.header {
  background: var(--card);
  border: 2px solid var(--ink);
  padding: 16px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header h1 {
  font-size: 32px;
  font-weight: bold;
  color: var(--ink);
}

.header .subtitle {
  font-size: 12px;
  color: var(--muted);
  margin-top: -4px;
}

/* Advisor Banner */
.advisor-banner {
  background: var(--card);
  border: 2px solid var(--ink);
  border-top: none;
  padding: 12px 24px;
  text-align: center;
}

.advisor-banner h2 {
  font-size: 18px;
  font-weight: 600;
  color: var(--ink);
}

/* Main Layout */
.main-layout {
  display: flex;
  height: calc(100vh - 120px);
  border: 2px solid var(--ink);
  border-top: none;
}

/* Columns */
.column {
  border-right: 2px solid var(--ink);
  background: var(--card);
  display: flex;
  flex-direction: column;
}

.column:last-child {
  border-right: none;
}

.column-header {
  background: var(--soft);
  border-bottom: 2px solid var(--ink);
  padding: 12px 16px;
  font-weight: bold;
  font-size: 16px;
  color: var(--ink);
}

.column-body {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}

/* Clients Column */
.clients-column {
  width: 200px;
  min-width: 200px;
}

.client-item {
  padding: 12px 16px;
  border-bottom: 1px solid var(--hair);
  cursor: pointer;
  transition: all 0.2s ease;
}

.client-item:hover {
  background: var(--soft);
}

.client-item.active {
  background: var(--maroon);
  color: white;
  font-weight: 600;
}

/* Documents Column */
.documents-column {
  flex: 1;
  min-width: 400px;
}

.upload-area {
  border: 2px dashed var(--border);
  border-radius: 8px;
  padding: 24px;
  text-align: center;
  margin-bottom: 20px;
  background: var(--soft);
  position: relative;
  transition: all 0.2s ease;
}

.upload-area:hover {
  border-color: var(--maroon);
  background: #fff3f6;
}

.upload-input {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  opacity: 0;
  cursor: pointer;
}

.upload-text {
  color: var(--muted);
  font-size: 14px;
}

.doc-controls {
  display: flex;
  gap: 16px;
  margin-bottom: 16px;
  align-items: center;
}

.search-bar {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 13px;
}

.doc-control {
  color: var(--maroon);
  text-decoration: underline;
  cursor: pointer;
  font-size: 12px;
}

.doc-control:hover {
  color: var(--maroon2);
}

.doc-list {
  border-top: 1px solid var(--hair);
}

.doc-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid var(--hair);
}

.doc-item:hover {
  background: var(--soft);
  margin: 0 -16px;
  padding-left: 16px;
  padding-right: 16px;
}

.doc-info {
  flex: 1;
}

.doc-name {
  font-weight: 500;
  color: var(--ink);
  margin-bottom: 2px;
}

.doc-date {
  font-size: 11px;
  color: var(--muted);
}

.doc-actions {
  display: flex;
  gap: 8px;
  font-size: 11px;
}

.doc-action {
  color: var(--maroon);
  text-decoration: underline;
  cursor: pointer;
}

.doc-action:hover {
  color: var(--maroon2);
}

/* Generate Column */
.generate-column {
  width: 240px;
  min-width: 240px;
}

.generator-form {
  margin-bottom: 24px;
}

.generator-select {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 13px;
  margin-bottom: 12px;
  background: white;
}

.generator-btn {
  width: 100%;
  padding: 10px 16px;
  background: var(--maroon);
  color: white;
  border: 1px solid var(--maroon);
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 13px;
  transition: all 0.2s ease;
  margin-bottom: 8px;
}

.generator-btn:hover:not(:disabled) {
  background: var(--maroon2);
  border-color: var(--maroon2);
}

.generator-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.test-btn {
  background: var(--info);
  border-color: var(--info);
}

.test-btn:hover:not(:disabled) {
  background: #1e4a7a;
  border-color: #1e4a7a;
}

.queue-section {
  border-top: 2px solid var(--ink);
  padding-top: 16px;
}

.queue-header {
  font-weight: bold;
  font-size: 14px;
  color: var(--ink);
  margin-bottom: 12px;
}

.queue-item {
  background: var(--soft);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 10px 12px;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.spinner {
  width: 14px;
  height: 14px;
  border: 2px solid var(--border);
  border-left-color: var(--maroon);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.queue-item-content {
  flex: 1;
  font-size: 12px;
}

.queue-item-name {
  font-weight: 600;
  color: var(--ink);
  margin-bottom: 2px;
}

.queue-item-client {
  color: var(--muted);
  font-size: 11px;
}

.queue-timer {
  font-size: 11px;
  color: var(--info);
  font-weight: 600;
}

.queue-cancel {
  background: none;
  border: none;
  color: var(--muted);
  cursor: pointer;
  font-size: 12px;
  padding: 2px 4px;
  border-radius: 3px;
}

.queue-cancel:hover {
  background: rgba(220, 53, 69, 0.1);
  color: #dc3545;
}

/* PDF Viewer */
dialog#viewer {
  width: min(1100px, 95vw);
  height: min(90vh, 900px);
  border: 0;
  border-radius: 8px;
  padding: 0;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0,0,0,.28);
  margin: auto;
}

dialog::backdrop {
  background: rgba(0,0,0,.55);
}

.viewer-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #111827;
  color: #fff;
  padding: 10px 14px;
}

.viewer-title {
  font-weight: 700;
  font-size: 14px;
}

.close-btn {
  background: #374151;
  border: 1px solid #4B5563;
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
}

.close-btn:hover {
  background: #4B5563;
}

#viewerFrame {
  width: 100%;
  height: calc(100% - 44px);
  border: 0;
  background: #f5f6f7;
}

.empty-state {
  text-align: center;
  color: var(--muted);
  font-style: italic;
  padding: 40px 20px;
}

/* Responsive */
@media (max-width: 768px) {
  .main-layout {
    flex-direction: column;
    height: auto;
  }
  
  .column {
    border-right: none;
    border-bottom: 2px solid var(--ink);
  }
  
  .column:last-child {
    border-bottom: none;
  }
  
  .clients-column,
  .generate-column {
    width: 100%;
  }
  
  .column-body {
    max-height: 300px;
  }
}
</style>
</head>
<body>

<div class="header">
  <div>
    <h1>DocuGen</h1>
    <div class="subtitle">By Doculabs</div>
  </div>
  <h1>Finance</h1>
</div>

<div class="advisor-banner">
  <h2>Advisor Details</h2>
</div>

<div class="main-layout">
  <!-- Clients Column -->
  <div class="column clients-column">
    <div class="column-header">Clients</div>
    <div class="column-body">
      <div id="clientList"></div>
    </div>
  </div>

  <!-- Documents Column -->
  <div class="column documents-column">
    <div class="column-header" id="documentsHeader">${Client}Documents</div>
    <div class="column-body">
      <div class="upload-area">
        <input type="file" class="upload-input" id="fileUpload" onchange="handleFileUpload(event)" multiple accept=".pdf,.doc,.docx,.xlsx,.ppt,.pptx">
        <div class="upload-text">Drop files here or click to upload</div>
      </div>
      
      <div class="doc-controls">
        <input type="text" class="search-bar" id="searchBar" placeholder="Search documents..." onkeyup="searchDocuments()">
        <span class="doc-control" onclick="sortDocuments()">Sort by Date</span>
        <span class="doc-control" onclick="toggleDocuments()">Toggle All</span>
      </div>
      
      <div class="doc-list" id="documentsList"></div>
    </div>
  </div>

  <!-- Generate Column -->
  <div class="column generate-column">
    <div class="column-header">Generate</div>
    <div class="column-body">
      <div class="generator-form">
        <select class="generator-select" id="docTypeSelect">
          <option value="">Select document type...</option>
          <option value="Portfolio Analysis">Portfolio Analysis</option>
          <option value="15 min Meeting Preparation">15 min Meeting Preparation</option>
          <option value="45 min Meeting Preparation">45 min Meeting Preparation</option>
          <option value="Quarterly Report">Quarterly Report</option>
          <option value="Tax Planning">Tax Planning Document</option>
          <option value="Retirement Planning">Retirement Planning</option>
          <option value="Client Current State">Client Current State</option>
          <option value="Risk Assessment">Risk Assessment</option>
          <option value="Compose Correspondence">Compose Correspondence</option>
        </select>
        <button class="generator-btn" id="generateBtn" onclick="generateDocument()">Generate</button>
        <button class="generator-btn test-btn" id="testApiBtn" onclick="testVertesiaAPI()">Test API Call</button>
      </div>
      
      <div class="queue-section">
        <div class="queue-header">In Queue</div>
        <div id="queueItems"></div>
      </div>
    </div>
  </div>
</div>

<!-- PDF Viewer Dialog -->
<dialog id="viewer" aria-label="Document viewer">
  <div class="viewer-header">
    <div class="viewer-title" id="viewerTitle">Document</div>
    <button type="button" class="close-btn" id="closeViewer">Close</button>
  </div>
  <iframe id="viewerFrame"></iframe>
</dialog>

<script>
// Simplified client data - just names for the list
const clientsData = {
  'ahmed': { name: 'Ahmed Ishmal' },
  'chris': { name: 'Chris Lehman' },
  'robert': { name: 'Robert Thompson' },
  'jennifer': { name: 'Jennifer Kim' },
  'david': { name: 'David Chen' }
};

// Document data - starts empty, will be populated by API
let documentsData = [];

let currentClient = 'ahmed';
let sortOrder = 'desc';
let documentsVisible = true;

// Test Vertesia API function
async function testVertesiaAPI() {
  const testBtn = document.getElementById('testApiBtn');
  testBtn.disabled = true;
  testBtn.textContent = 'Testing...';
  
  try {
    console.log('Making API call to Vertesia...');
    
    const response = await fetch('https://api.vertesia.io/api/v1/objects?limit=100&offset=0', {
      method: 'GET',
      headers: {
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9',
        'Content-Type': 'application/json'
      }
    });
    
    console.log('Response status:', response.status);
    console.log('Response headers:', response.headers);
    
    if (response.ok) {
      const result = await response.json();
      console.log('API Response:', result);
      console.log('Number of documents:', Array.isArray(result) ? result.length : 'Response is not an array');
      
      // Try to convert to our format
      if (Array.isArray(result)) {
        documentsData = result.map(doc => ({
          id: doc.id,
          name: doc.name || doc.title || 'Unnamed Document',
          date: doc.created_at || doc.updated_at || new Date().toISOString().split('T')[0],
          client: extractClientFromName(doc.name || ''),
          type: doc.type || 'vertesia',
          vertesiaId: doc.id,
          status: doc.status
        }));
        
        alert(`Successfully loaded ${documentsData.length} documents! Check console for details.`);
        renderDocuments();
      } else if (result && typeof result === 'object') {
        // Maybe it's an object with a data property or similar
        console.log('Response structure:', Object.keys(result));
        if (result.data && Array.isArray(result.data)) {
          documentsData = result.data.map(doc => ({
            id: doc.id,
            name: doc.name || doc.title || 'Unnamed Document',
            date: doc.created_at || doc.updated_at || new Date().toISOString().split('T')[0],
            client: extractClientFromName(doc.name || ''),
            type: doc.type || 'vertesia',
            vertesiaId: doc.id
          }));
          
          alert(`Successfully loaded ${documentsData.length} documents from result.data! Check console.`);
          renderDocuments();
        } else {
          alert('API returned object but no recognizable data array. Check console.');
        }
      } else {
        console.log('Unexpected response structure:', result);
        alert('API returned data but in unexpected format. Check console.');
      }
    } else {
      const errorText = await response.text();
      console.error('API Error Response:', errorText);
      alert(`API call failed with status ${response.status}. Check console for details.`);
    }
  } catch (error) {
    console.error('Network error:', error);
    alert('Network error occurred. Check console for details.');
  } finally {
    testBtn.disabled = false;
    testBtn.textContent = 'Test API Call';
  }
}

function extractClientFromName(docName) {
  if (!docName) return 'all';
  
  for (const [clientId, client] of Object.entries(clientsData)) {
    if (docName.toLowerCase().includes(client.name.toLowerCase())) {
      return clientId;
    }
  }
  return 'all';
}

// Document Queue Class (simplified for right panel)
class DocumentQueue {
  constructor() {
    this.activeGenerations = new Map();
    this.timers = new Map();
  }
  
  addGeneration(docType, clientId) {
    const id = Date.now() + Math.random();
    const generation = {
      id,
      docType,
      clientId,
      clientName: clientsData[clientId].name,
      startTime: Date.now(),
      estimatedDuration: 5 * 60 * 1000
    };
    
    this.activeGenerations.set(id, generation);
    this.startTimer(id);
    this.updateQueueDisplay();
    return id;
  }
  
  startTimer(id) {
    const timer = setInterval(() => {
      const generation = this.activeGenerations.get(id);
      if (!generation) {
        clearInterval(timer);
        return;
      }
      
      const elapsed = Date.now() - generation.startTime;
      if (elapsed >= generation.estimatedDuration) {
        this.completeGeneration(id);
      }
      this.updateQueueDisplay();
    }, 1000);
    
    this.timers.set(id, timer);
  }
  
  completeGeneration(id) {
    const generation = this.activeGenerations.get(id);
    if (generation) {
      const newDoc = {
        id: Date.now(),
        name: generation.docType,
        date: new Date().toISOString().split('T')[0],
        client: generation.clientId,
        type: 'generated'
      };
      
      documentsData.unshift(newDoc);
      if (generation.clientId === currentClient) {
        renderDocuments();
      }
    }
    
    this.removeGeneration(id);
  }
  
  removeGeneration(id) {
    clearInterval(this.timers.get(id));
    this.timers.delete(id);
    this.activeGenerations.delete(id);
    this.updateQueueDisplay();
  }
  
  updateQueueDisplay() {
    const itemsElement = document.getElementById('queueItems');
    itemsElement.innerHTML = '';
    
    this.activeGenerations.forEach(generation => {
      const elapsed = Date.now() - generation.startTime;
      const remaining = Math.max(0, generation.estimatedDuration - elapsed);
      const minutes = Math.floor(remaining / 60000);
      const seconds = Math.floor((remaining % 60000) / 1000);
      
      const div = document.createElement('div');
      div.className = 'queue-item';
      div.innerHTML = `
        <div class="spinner"></div>
        <div class="queue-item-content">
          <div class="queue-item-name">${generation.docType}</div>
          <div class="queue-item-client">${generation.clientName}</div>
        </div>
        <span class="queue-timer">${minutes}:${seconds.toString().padStart(2, '0')}</span>
        <button class="queue-cancel" onclick="documentQueue.removeGeneration(${generation.id})">✕</button>
      `;
      itemsElement.appendChild(div);
    });
  }
}

const documentQueue = new DocumentQueue();

// PDF Viewer Functions
const DOC_DIR = './docs';

function fileUrlFromTitle(title) {
  return `${DOC_DIR}/${title}.pdf?t=${Date.now()}#page=1&zoom=page-fit`;
}

function openViewer(url, title) {
  const dlg = document.getElementById('viewer');
  document.getElementById('viewerTitle').textContent = title || 'Document';
  document.getElementById('viewerFrame').src = url + '#page=1';
  dlg.showModal();
}

function closeViewer() {
  const dlg = document.getElementById('viewer');
  document.getElementById('viewerFrame').src = 'about:blank';
  if (dlg?.open) dlg.close();
}

// Initialize
function init() {
  renderClients();
  switchClient('ahmed');
  renderDocuments(); // Will show empty initially
  
  // Initialize viewer
  document.getElementById('closeViewer').addEventListener('click', closeViewer);
  
  document.getElementById('viewer').addEventListener('click', (e) => {
    const r = e.target.getBoundingClientRect();
    const outside = e.clientX < r.left || e.clientX > r.right || e.clientY < r.top || e.clientY > r.bottom;
    if (outside) closeViewer();
  });
  
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && document.getElementById('viewer').open) closeViewer();
  });
}

// Render client list
function renderClients() {
  const clientList = document.getElementById('clientList');
  clientList.innerHTML = '';
  
  Object.keys(clientsData).forEach(clientId => {
    const client = clientsData[clientId];
    const div = document.createElement('div');
    div.className = `client-item ${clientId === currentClient ? 'active' : ''}`;
    div.textContent = client.name.split(' ')[0];
    div.onclick = () => switchClient(clientId);
    clientList.appendChild(div);
  });
}

// Switch client
async function switchClient(clientId) {
  currentClient = clientId;
  const client = clientsData[clientId];
  
  // Update UI
  document.getElementById('documentsHeader').textContent = `${client.name}Documents`;
  renderClients();
  
  // Load documents for this specific client
  await loadClientDocuments(clientId);
}

async function loadClientDocuments(clientId) {
  const client = clientsData[clientId];
  
  try {
    // Search for documents containing this client's name
    const response = await fetch(`https://api.vertesia.io/api/v1/objects?name=${encodeURIComponent(client.name)}&limit=50`, {
      method: 'GET',
      headers: {
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9',
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      const result = await response.json();
      
      // Convert to our format and assign to current client
      documentsData = result.map(doc => ({
        id: doc.id,
        name: doc.name,
        date: doc.created_at || doc.updated_at,
        client: clientId,
        type: 'vertesia',
        vertesiaId: doc.id
      }));
      
      renderDocuments();
    }
  } catch (error) {
    console.error('Failed to load client documents:', error);
  }
}

// File upload
async function handleFileUpload(event) {
  const files = event.target.files;
  if (files.length === 0) return;
  
  const uploadArea = document.querySelector('.upload-area');
  uploadArea.style.background = '#fff3f6';
  uploadArea.style.borderColor = '#8B1538';
  
  try {
    for (const file of files) {
      const clientName = clientsData[currentClient].name;
      const fileName = `${clientName} - ${file.name}`;
      
      console.log(`Step 1: Getting upload URL for: ${fileName}`);
      
      // Step 1: Get upload URL from Vertesia
      const urlResponse = await fetch('https://api.vertesia.io/api/v1/objects/upload-url', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9'
        },
        body: JSON.stringify({
          "name": fileName,
          "mime_type": file.type || "application/pdf"
        })
      });
      
      if (!urlResponse.ok) {
        throw new Error(`Failed to get upload URL: ${urlResponse.status}`);
      }
      
      const uploadData = await urlResponse.json();
      console.log('Step 1 complete. Upload data:', uploadData);
      
      // Step 2: Upload to Google Cloud Storage
      console.log(`Step 2: Uploading ${file.size} bytes to GCS...`);
      
      const fileUploadResponse = await fetch(uploadData.url, {
        method: 'PUT',
        body: file
      });
      
      console.log('Upload response status:', fileUploadResponse.status);
      
      if (!fileUploadResponse.ok) {
        const errorText = await fileUploadResponse.text();
        console.error('Upload error response:', errorText);
        throw new Error(`Failed to upload file: ${fileUploadResponse.status}`);
      }
      
      console.log('Step 2 complete - file uploaded to GCS');
      
      // Step 3: Create the content object in Vertesia
      console.log('Step 3: Creating content object in Vertesia...');
      
      const createObjectResponse = await fetch('https://api.vertesia.io/api/v1/objects', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9'
        },
        body: JSON.stringify({
          "name": fileName,
          "description": `Document uploaded for ${clientName}`,
          "content": {
            "source": `gs://store_prod_dd0d3a_2ca798/${uploadData.id}`, // Using the ID from step 1
            "type": file.type || "application/pdf",
            "name": file.name
          },
          "properties": {
            "client": clientName,
            "uploaded_at": new Date().toISOString()
          }
        })
      });
      
      if (!createObjectResponse.ok) {
        const errorText = await createObjectResponse.text();
        console.error('Create object error:', errorText);
        throw new Error(`Failed to create object: ${createObjectResponse.status}`);
      }
      
      const createdObject = await createObjectResponse.json();
      console.log('Step 3 complete - object created:', createdObject);
    }
    
    // Refresh the document list
    setTimeout(() => loadClientDocuments(currentClient), 1000);
    alert(`Successfully uploaded ${files.length} file(s)`);
    
  } catch (error) {
    console.error('Upload error:', error);
    alert(`Upload failed: ${error.message}`);
  } finally {
    setTimeout(() => {
      uploadArea.style.background = '';
      uploadArea.style.borderColor = '';
    }, 1000);
    event.target.value = '';
  }
}

// Generate document
async function generateDocument() {
  const select = document.getElementById('docTypeSelect');
  const selectedDocType = select.value; // Capture the value before any other operations
  
  if (!selectedDocType) {
    alert('Please select a document type');
    return;
  }
  
  // Add to queue with the captured value
  documentQueue.addGeneration(selectedDocType, currentClient);
  
  // Now reset the select
  select.value = '';
  
  try {
    await fetch('https://api.vertesia.io/api/v1/execute/async', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9'
      },
      body: JSON.stringify({
        "type": "conversation",
        "interaction": "AdvisorAssistant@2",
        "data": {
          "task": `For ${clientsData[currentClient].name} create a ${selectedDocType} document`
        },
        "config": {
          "environment": "681915c6a01fb262a410c161",
          "model": "publishers/anthropic/models/claude-3-7-sonnet"
        }
      })
    });
    
    console.log(`Document generation started: ${selectedDocType} for ${clientsData[currentClient].name}`);
  } catch (error) {
    console.error('API error:', error);
  }
}

// Search documents
function searchDocuments() {
  const query = document.getElementById('searchBar').value.toLowerCase();
  renderDocuments(query);
}

// Sort documents
function sortDocuments() {
  sortOrder = sortOrder === 'desc' ? 'asc' : 'desc';
  renderDocuments();
}

// Toggle documents
function toggleDocuments() {
  documentsVisible = !documentsVisible;
  const docItems = document.querySelectorAll('.doc-item');
  docItems.forEach(item => {
    item.style.display = documentsVisible ? 'flex' : 'none';
  });
}

// Render documents
function renderDocuments(searchQuery = '') {
  const docsList = document.getElementById('documentsList');
  docsList.innerHTML = '';
  
  let filteredDocs = documentsData.filter(doc => 
    (doc.client === currentClient || doc.client === 'all') &&
    (searchQuery === '' || doc.name.toLowerCase().includes(searchQuery))
  );
  
  if (filteredDocs.length === 0) {
    const emptyDiv = document.createElement('div');
    emptyDiv.className = 'empty-state';
    emptyDiv.textContent = 'No documents found. Try uploading files or generating new documents.';
    docsList.appendChild(emptyDiv);
    return;
  }
  
  filteredDocs.sort((a, b) => {
    const dateA = new Date(a.date);
    const dateB = new Date(b.date);
    return sortOrder === 'desc' ? dateB - dateA : dateA - dateB;
  });
  
  filteredDocs.forEach((doc, index) => {
    const div = document.createElement('div');
    div.className = 'doc-item';
    div.innerHTML = `
      <div class="doc-info">
        <div class="doc-name">${doc.name}</div>
        <div class="doc-date">${doc.date}</div>
      </div>
      <div class="doc-actions">
        <span class="doc-action" onclick="viewDocument('${doc.id}')">view</span>
        <span class="doc-action" onclick="downloadDocument('${doc.id}')">download</span>
        <span class="doc-action" onclick="deleteDocument('${doc.id}')">delete</span>
      </div>
    `;
    docsList.appendChild(div);
  });
}

// Document actions
async function viewDocument(id) {
  const doc = documentsData.find(d => d.id === id);
  
  if (!doc || !doc.vertesiaId) {
    alert('Cannot view this document - missing ID');
    return;
  }
  
  try {
    // Step 1: Get the object details to find content.source
    console.log(`Getting object details for ${doc.vertesiaId}...`);
    const objectResponse = await fetch(`https://api.vertesia.io/api/v1/objects/${doc.vertesiaId}`, {
      headers: { 
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9' 
      }
    });
    
    if (!objectResponse.ok) {
      throw new Error(`Failed to get object: ${objectResponse.status}`);
    }
    
    const objectData = await objectResponse.json();
    const fileUri = objectData.content?.source;
    
    if (!fileUri) {
      throw new Error('No file source found in object');
    }
    
    console.log(`File URI: ${fileUri}`);
    
    // Step 2: Get downloadable URL
    console.log('Getting signed download URL...');
    const downloadResponse = await fetch('https://api.vertesia.io/api/v1/objects/download-url', {
      method: 'POST',
      headers: { 
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ 
        "file": fileUri 
      })
    });
    
    if (!downloadResponse.ok) {
      throw new Error(`Failed to get download URL: ${downloadResponse.status}`);
    }
    
    const downloadData = await downloadResponse.json();
    console.log('Got signed URL, opening viewer...');
    
    // Step 3: Open in your existing viewer
    openViewer(downloadData.url, doc.name);
    
  } catch (error) {
    console.error('View document error:', error);
    alert(`Failed to view document: ${error.message}`);
  }
}

async function downloadDocument(id) {
  const doc = documentsData.find(d => d.id === id);
  
  if (!doc || !doc.vertesiaId) {
    alert('Cannot download this document - missing ID');
    return;
  }
  
  try {
    console.log(`Getting object details for download: ${doc.vertesiaId}...`);
    const objectResponse = await fetch(`https://api.vertesia.io/api/v1/objects/${doc.vertesiaId}`, {
      headers: { 
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9' 
      }
    });
    
    if (!objectResponse.ok) {
      throw new Error(`Failed to get object: ${objectResponse.status}`);
    }
    
    const objectData = await objectResponse.json();
    const fileUri = objectData.content?.source;
    
    if (!fileUri) {
      throw new Error('No file source found in object');
    }
    
    console.log('Getting signed download URL...');
    const downloadResponse = await fetch('https://api.vertesia.io/api/v1/objects/download-url', {
      method: 'POST',
      headers: { 
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ 
        "file": fileUri 
      })
    });
    
    if (!downloadResponse.ok) {
      throw new Error(`Failed to get download URL: ${downloadResponse.status}`);
    }
    
    const downloadData = await downloadResponse.json();
    
    // Fetch the actual file content as a blob
    console.log('Downloading file content...');
    const fileResponse = await fetch(downloadData.url);
    
    if (!fileResponse.ok) {
      throw new Error(`Failed to fetch file: ${fileResponse.status}`);
    }
    
    const blob = await fileResponse.blob();
    
    // Create a blob URL and force download
    const blobUrl = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = blobUrl;
    link.download = doc.name; // This forces download instead of opening
    link.style.display = 'none';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Clean up the blob URL
    setTimeout(() => URL.revokeObjectURL(blobUrl), 1000);
    
    console.log(`Download completed: ${doc.name}`);
    
  } catch (error) {
    console.error('Download document error:', error);
    alert(`Failed to download document: ${error.message}`);
  }
}

function deleteDocument(id) {
  if (confirm('Are you sure you want to delete this document?')) {
    documentsData = documentsData.filter(d => d.id !== id);
    renderDocuments();
  }
}

// Initialize on page load
window.onload = init;
</script>

</body>
</html>
