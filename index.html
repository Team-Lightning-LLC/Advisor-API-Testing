<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DocuGen Finance</title>
<!-- Add marked.js library for markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
:root {
  --maroon: #8B1538;
  --maroon2: #A61E1E;
  --ink: #1f2d3d;
  --muted: #6c7a89;
  --border: #e0e5ea;
  --hair: #eceff3;
  --bg: #f5f6f7;
  --card: #fff;
  --soft: #f8f9fb;
  --ok: #1f7a4d;
  --warn: #8a5a00;
  --info: #2d5699;
}

* { 
  margin: 0; 
  padding: 0; 
  box-sizing: border-box; 
}

body { 
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  font-size: 14px; 
  background: var(--bg); 
  color: var(--ink);
  line-height: 1.4;
}

/* Header */
.header {
  background: var(--card);
  border: 2px solid var(--ink);
  padding: 16px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header h1 {
  font-size: 32px;
  font-weight: bold;
  color: var(--ink);
}

.header .subtitle {
  font-size: 12px;
  color: var(--muted);
  margin-top: -4px;
}

/* Advisor Banner */
.advisor-banner {
  background: var(--card);
  border: 2px solid var(--ink);
  border-top: none;
  padding: 12px 24px;
  text-align: center;
}

.advisor-banner h2 {
  font-size: 18px;
  font-weight: 600;
  color: var(--ink);
}

/* Main Layout */
.main-layout {
  display: flex;
  height: calc(100vh - 120px);
  border: 2px solid var(--ink);
  border-top: none;
}

/* Columns */
.column {
  border-right: 2px solid var(--ink);
  background: var(--card);
  display: flex;
  flex-direction: column;
}

.column:last-child {
  border-right: none;
}

.column-header {
  background: var(--soft);
  border-bottom: 2px solid var(--ink);
  padding: 12px 16px;
  font-weight: bold;
  font-size: 16px;
  color: var(--ink);
  display: flex;
  align-items: center;
}

.column-body {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}

/* Clients Column */
.clients-column {
  width: 200px;
  min-width: 200px;
}

.client-item {
  padding: 12px 16px;
  border-bottom: 1px solid var(--hair);
  cursor: pointer;
  transition: all 0.2s ease;
}

.client-item:hover {
  background: var(--soft);
}

.client-item.active {
  background: var(--maroon);
  color: white;
  font-weight: 600;
}

/* Client header actions */
.client-header-actions {
  display: flex;
  gap: 6px;
  margin-left: auto;
}

.refresh-clients-btn {
  background: var(--info);
  color: white;
  border: none;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 14px;
  line-height: 1;
  transition: all 0.2s ease;
}

.refresh-clients-btn:hover {
  background: #1e4a7a;
  transform: rotate(180deg);
}

/* Documents Column */
.documents-column {
  flex: 1;
  min-width: 400px;
}

.upload-area {
  border: 2px dashed var(--border);
  border-radius: 8px;
  padding: 24px;
  text-align: center;
  margin-bottom: 20px;
  background: var(--soft);
  position: relative;
  transition: all 0.2s ease;
}

.upload-area:hover {
  border-color: var(--maroon);
  background: #fff3f6;
}

.upload-input {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  opacity: 0;
  cursor: pointer;
}

.upload-text {
  color: var(--muted);
  font-size: 14px;
}

/* AI Profile Status Section */
.profile-status-section {
  background: var(--soft);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 20px;
}

.profile-status-header {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  color: var(--ink);
  margin-bottom: 12px;
  font-size: 14px;
}

.profile-icon {
  font-size: 16px;
}

.profile-complete {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--ok);
  font-weight: 500;
  font-size: 13px;
}

.profile-needed {
  display: flex;
  align-items: center;
  gap: 12px;
  color: var(--warn);
  font-size: 13px;
}

.status-light {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
  flex-shrink: 0;
}

.status-light.green {
  background: var(--ok);
}

.status-light.red {
  background: #dc3545;
}

.generate-profile-btn {
  background: var(--info);
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 500;
  transition: background 0.2s ease;
}

.generate-profile-btn:hover {
  background: #1e4a7a;
}

.generate-profile-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.doc-controls {
  display: flex;
  gap: 16px;
  margin-bottom: 16px;
  align-items: center;
}

.search-bar {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 13px;
}

.doc-control {
  color: var(--maroon);
  text-decoration: underline;
  cursor: pointer;
  font-size: 12px;
}

.doc-control:hover {
  color: var(--maroon2);
}

.doc-list {
  border-top: 1px solid var(--hair);
}

.doc-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid var(--hair);
}

.doc-item:hover {
  background: var(--soft);
  margin: 0 -16px;
  padding-left: 16px;
  padding-right: 16px;
}

.doc-info {
  flex: 1;
}

.doc-name {
  font-weight: 500;
  color: var(--ink);
  margin-bottom: 2px;
}

.doc-date {
  font-size: 11px;
  color: var(--muted);
}

.doc-actions {
  display: flex;
  gap: 8px;
  font-size: 11px;
}

.doc-action {
  color: var(--maroon);
  text-decoration: underline;
  cursor: pointer;
}

.doc-action:hover {
  color: var(--maroon2);
}

/* Generate Column */
.generate-column {
  width: 240px;
  min-width: 240px;
}

.generator-form {
  margin-bottom: 24px;
}

.generator-select {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 13px;
  margin-bottom: 12px;
  background: white;
}

.generator-btn {
  width: 100%;
  padding: 10px 16px;
  background: var(--maroon);
  color: white;
  border: 1px solid var(--maroon);
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 13px;
  transition: all 0.2s ease;
  margin-bottom: 8px;
}

.generator-btn:hover:not(:disabled) {
  background: var(--maroon2);
  border-color: var(--maroon2);
}

.generator-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.test-btn {
  background: var(--info);
  border-color: var(--info);
}

.test-btn:hover:not(:disabled) {
  background: #1e4a7a;
  border-color: #1e4a7a;
}

.queue-section {
  border-top: 2px solid var(--ink);
  padding-top: 16px;
}

.queue-header {
  font-weight: bold;
  font-size: 14px;
  color: var(--ink);
  margin-bottom: 12px;
}

.queue-item {
  background: var(--soft);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 10px 12px;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.spinner {
  width: 14px;
  height: 14px;
  border: 2px solid var(--border);
  border-left-color: var(--maroon);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.queue-item-content {
  flex: 1;
  font-size: 12px;
}

.queue-item-name {
  font-weight: 600;
  color: var(--ink);
  margin-bottom: 2px;
}

.queue-item-client {
  color: var(--muted);
  font-size: 11px;
}

.queue-timer {
  font-size: 11px;
  color: var(--info);
  font-weight: 600;
}

.queue-cancel {
  background: none;
  border: none;
  color: var(--muted);
  cursor: pointer;
  font-size: 12px;
  padding: 2px 4px;
  border-radius: 3px;
}

.queue-cancel:hover {
  background: rgba(220, 53, 69, 0.1);
  color: #dc3545;
}

/* Document Viewer */
dialog#viewer {
  width: min(1100px, 95vw);
  height: min(90vh, 900px);
  border: 0;
  border-radius: 8px;
  padding: 0;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0,0,0,.28);
  margin: auto;
}

dialog::backdrop {
  background: rgba(0,0,0,.55);
}

.viewer-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #111827;
  color: #fff;
  padding: 10px 14px;
}

.viewer-title {
  font-weight: 700;
  font-size: 14px;
}

.close-btn {
  background: #374151;
  border: 1px solid #4B5563;
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
}

.close-btn:hover {
  background: #4B5563;
}

#viewerFrame {
  width: 100%;
  height: calc(100% - 44px);
  border: 0;
  background: #f5f6f7;
}

/* Document viewer content styling */
.viewer-content {
  padding: 30px 40px;
  max-width: 900px;
  margin: 0 auto;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  line-height: 1.6;
  color: #1f2d3d;
  background: white;
  height: calc(100% - 44px);
  overflow-y: auto;
}

.viewer-content h1 {
  font-size: 28px;
  color: #8B1538;
  border-bottom: 3px solid #8B1538;
  padding-bottom: 12px;
  margin: 30px 0 20px 0;
  font-weight: 700;
}

.viewer-content h2 {
  font-size: 22px;
  color: #1f2d3d;
  margin: 25px 0 15px 0;
  font-weight: 600;
  border-left: 4px solid #8B1538;
  padding-left: 12px;
}

.viewer-content h3 {
  font-size: 18px;
  color: #1f2d3d;
  margin: 20px 0 12px 0;
  font-weight: 600;
}

.viewer-content h4 {
  font-size: 16px;
  color: #1f2d3d;
  margin: 18px 0 10px 0;
  font-weight: 600;
}

.viewer-content p {
  margin-bottom: 16px;
  text-align: justify;
}

.viewer-content ul, .viewer-content ol {
  margin: 16px 0;
  padding-left: 30px;
}

.viewer-content li {
  margin-bottom: 8px;
}

.viewer-content ul ul, .viewer-content ol ol {
  margin: 8px 0;
}

.viewer-content strong {
  color: #8B1538;
  font-weight: 600;
}

.viewer-content em {
  font-style: italic;
}

.viewer-content table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  font-size: 14px;
}

.viewer-content table th {
  background-color: #f8f9fb;
  border: 1px solid #e0e5ea;
  padding: 12px 8px;
  text-align: left;
  font-weight: 600;
  color: #1f2d3d;
}

.viewer-content table td {
  border: 1px solid #e0e5ea;
  padding: 10px 8px;
  text-align: left;
}

.viewer-content table tr:nth-child(even) {
  background-color: #f8f9fb;
}

.viewer-content blockquote {
  border-left: 4px solid #8B1538;
  margin: 20px 0;
  padding: 10px 20px;
  background-color: #f8f9fb;
  font-style: italic;
}

.viewer-content code {
  background-color: #f5f6f7;
  padding: 2px 6px;
  border-radius: 3px;
  font-family: 'Courier New', monospace;
  font-size: 13px;
}

.viewer-content pre {
  background-color: #f5f6f7;
  padding: 15px;
  border-radius: 6px;
  overflow-x: auto;
  margin: 20px 0;
}

.viewer-content hr {
  border: none;
  border-top: 2px solid #e0e5ea;
  margin: 30px 0;
}

.empty-state {
  text-align: center;
  color: var(--muted);
  font-style: italic;
  padding: 40px 20px;
}

/* Delete Modal */
#deleteModal {
  width: min(500px, 90vw);
  border: 0;
  border-radius: 8px;
  padding: 0;
  box-shadow: 0 20px 60px rgba(0,0,0,.3);
  margin: auto;
}

#deleteModal::backdrop {
  background: rgba(0,0,0,.6);
}

.delete-modal-content {
  background: white;
  border-radius: 8px;
  overflow: hidden;
}

.delete-modal-header {
  background: #dc3545;
  color: white;
  padding: 16px 20px;
  font-weight: 600;
}

.delete-modal-header h3 {
  margin: 0;
  font-size: 18px;
}

.delete-modal-body {
  padding: 20px;
}

.delete-warning {
  background: #fff3cd;
  border: 1px solid #ffeaa7;
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 16px;
  color: #856404;
  text-align: center;
}

.delete-modal-body p {
  margin-bottom: 16px;
  line-height: 1.5;
  color: var(--ink);
}

.document-info {
  background: var(--soft);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 20px;
  font-size: 13px;
}

.delete-confirmation {
  margin-bottom: 20px;
}

.checkbox-container {
  display: flex;
  align-items: flex-start;
  cursor: pointer;
  font-size: 14px;
  line-height: 1.4;
  gap: 10px;
}

.checkbox-container input[type="checkbox"] {
  margin: 0;
  opacity: 0;
  position: absolute;
}

.checkmark {
  width: 18px;
  height: 18px;
  background-color: white;
  border: 2px solid var(--border);
  border-radius: 4px;
  position: relative;
  flex-shrink: 0;
  margin-top: 2px;
}

.checkbox-container:hover .checkmark {
  border-color: var(--maroon);
}

.checkbox-container input:checked + .checkmark {
  background-color: var(--maroon);
  border-color: var(--maroon);
}

.checkbox-container input:checked + .checkmark::after {
  content: '';
  position: absolute;
  left: 5px;
  top: 2px;
  width: 4px;
  height: 8px;
  border: solid white;
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
}

.delete-modal-actions {
  background: var(--soft);
  padding: 16px 20px;
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

.cancel-btn {
  padding: 8px 16px;
  background: white;
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--ink);
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
}

.cancel-btn:hover {
  background: var(--soft);
}

.delete-btn {
  padding: 8px 16px;
  background: #dc3545;
  border: 1px solid #dc3545;
  border-radius: 6px;
  color: white;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
}

.delete-btn:hover:not(:disabled) {
  background: #c82333;
  border-color: #c82333;
}

.delete-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Add Client Button */
.add-client-btn {
  background: var(--maroon);
  color: white;
  border: none;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 16px;
  font-weight: bold;
  line-height: 1;
  transition: all 0.2s ease;
}

.add-client-btn:hover {
  background: var(--maroon2);
  transform: scale(1.1);
}

/* Add Client Modal */
#addClientModal {
  width: min(600px, 90vw);
  border: 0;
  border-radius: 8px;
  padding: 0;
  box-shadow: 0 20px 60px rgba(0,0,0,.3);
  margin: auto;
}

#addClientModal::backdrop {
  background: rgba(0,0,0,.6);
}

.add-client-modal-content {
  background: white;
  border-radius: 8px;
  overflow: hidden;
}

.add-client-modal-header {
  background: var(--maroon);
  color: white;
  padding: 16px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.add-client-modal-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.modal-close-btn {
  background: none;
  border: none;
  color: white;
  font-size: 24px;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
}

.modal-close-btn:hover {
  background: rgba(255,255,255,0.1);
}

.add-client-modal-body {
  padding: 20px;
}

.client-name-section {
  margin-bottom: 24px;
}

.client-name-section label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: var(--ink);
}

#clientNameInput {
  width: 100%;
  padding: 12px;
  border: 2px solid var(--border);
  border-radius: 6px;
  font-size: 14px;
  transition: border-color 0.2s ease;
}

#clientNameInput:focus {
  outline: none;
  border-color: var(--maroon);
}

.input-help {
  font-size: 12px;
  color: var(--muted);
  margin-top: 4px;
}

.upload-section {
  margin-bottom: 20px;
}

.upload-section label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: var(--ink);
}

.modal-upload-area {
  border: 2px dashed var(--border);
  border-radius: 8px;
  padding: 24px;
  text-align: center;
  background: var(--soft);
  position: relative;
  transition: all 0.2s ease;
  cursor: pointer;
}

.modal-upload-area:hover {
  border-color: var(--maroon);
  background: #fff3f6;
}

.modal-upload-input {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  opacity: 0;
  cursor: pointer;
}

.upload-icon {
  font-size: 32px;
  margin-bottom: 8px;
}

.modal-upload-text {
  color: var(--muted);
}

.upload-hint {
  font-size: 12px;
  margin-top: 4px;
}

.selected-files {
  margin-top: 12px;
}

.file-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
  background: var(--soft);
  border: 1px solid var(--border);
  border-radius: 6px;
  margin-bottom: 6px;
  font-size: 13px;
}

.file-remove {
  background: none;
  border: none;
  color: var(--muted);
  cursor: pointer;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 12px;
}

.file-remove:hover {
  background: rgba(220, 53, 69, 0.1);
  color: #dc3545;
}

.processing-info {
  background: #d1ecf1;
  border: 1px solid #bee5eb;
  border-radius: 6px;
  padding: 12px;
  font-size: 13px;
  color: #0c5460;
}

.add-client-modal-actions {
  background: var(--soft);
  padding: 16px 20px;
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

.create-btn {
  padding: 10px 20px;
  background: var(--maroon);
  border: 1px solid var(--maroon);
  border-radius: 6px;
  color: white;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
}

.create-btn:hover:not(:disabled) {
  background: var(--maroon2);
  border-color: var(--maroon2);
}

.create-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Responsive */
@media (max-width: 768px) {
  .main-layout {
    flex-direction: column;
    height: auto;
  }
  
  .column {
    border-right: none;
    border-bottom: 2px solid var(--ink);
  }
  
  .column:last-child {
    border-bottom: none;
  }
  
  .clients-column,
  .generate-column {
    width: 100%;
  }
  
  .column-body {
    max-height: 300px;
  }
}
</style>
</head>
<body>

<div class="header">
  <div>
    <h1>DocuGen</h1>
    <div class="subtitle">By Doculabs</div>
  </div>
  <h1>Finance</h1>
</div>

<div class="advisor-banner">
  <h2>Advisor Details</h2>
</div>

<div class="main-layout">
  <!-- Clients Column -->
  <div class="column clients-column">
    <div class="column-header">
      Clients
      <div class="client-header-actions">
        <button class="refresh-clients-btn" onclick="loadClientsFromVertesia()" title="Refresh Client List">↻</button>
        <button class="add-client-btn" onclick="openAddClientModal()" title="Add New Client">+</button>
      </div>
    </div>
    <div class="column-body">
      <div id="clientList"></div>
    </div>
  </div>

  <!-- Documents Column -->
  <div class="column documents-column">
    <div class="column-header" id="documentsHeader">Documents</div>
    <div class="column-body">
      <div class="upload-area">
        <input type="file" class="upload-input" id="fileUpload" onchange="handleFileUpload(event)" multiple accept=".pdf,.doc,.docx,.xlsx,.ppt,.pptx">
        <div class="upload-text">Drop files here or click to upload</div>
      </div>
      
      <!-- AI Profile Status Section -->
      <div class="profile-status-section">
        <div class="profile-status-header">
          <span class="profile-icon">👤</span>
          <span>AI Profile Status</span>
        </div>
        <div id="profileStatus" class="profile-status-content">
          <!-- Will be populated dynamically -->
        </div>
      </div>
      
      <div class="doc-controls">
        <input type="text" class="search-bar" id="searchBar" placeholder="Search documents..." onkeyup="searchDocuments()">
        <span class="doc-control" onclick="sortDocuments()">Sort by Date</span>
        <span class="doc-control" onclick="toggleDocuments()">Toggle All</span>
      </div>
      
      <div class="doc-list" id="documentsList"></div>
    </div>
  </div>

  <!-- Generate Column -->
  <div class="column generate-column">
    <div class="column-header">Generate</div>
    <div class="column-body">
      <div class="generator-form">
        <select class="generator-select" id="docTypeSelect">
          <option value="">Select document type...</option>
          <option value="Portfolio Analysis">Portfolio Analysis</option>
          <option value="15 min Meeting Preparation">15 min Meeting Preparation</option>
          <option value="45 min Meeting Preparation">45 min Meeting Preparation</option>
          <option value="Quarterly Report">Quarterly Report</option>
          <option value="Tax Planning">Tax Planning Document</option>
          <option value="Retirement Planning">Retirement Planning</option>
          <option value="Client Current State">Client Current State</option>
          <option value="Risk Assessment">Risk Assessment</option>
          <option value="Compose Correspondence">Compose Correspondence</option>
        </select>
        <button class="generator-btn" id="generateBtn" onclick="generateDocument()">Generate</button>
        <button class="generator-btn test-btn" id="testApiBtn" onclick="testVertesiaAPI()">Test API Call</button>
      </div>
      
      <div class="queue-section">
        <div class="queue-header">In Queue</div>
        <div id="queueItems"></div>
      </div>
    </div>
  </div>
</div>

<!-- Document Viewer Dialog -->
<dialog id="viewer" aria-label="Document viewer">
  <div class="viewer-header">
    <div class="viewer-title" id="viewerTitle">Document</div>
    <button type="button" class="close-btn" id="closeViewer">Close</button>
  </div>
  <iframe id="viewerFrame"></iframe>
</dialog>

<!-- Delete Confirmation Modal -->
<dialog id="deleteModal" aria-label="Delete confirmation">
  <div class="delete-modal-content">
    <div class="delete-modal-header">
      <h3>Delete Document</h3>
    </div>
    <div class="delete-modal-body">
      <div class="delete-warning">
        <strong>⚠️ This action cannot be undone.</strong>
      </div>
      <p>Deleting this document will permanently remove it from the database and exclude it from all future analysis and document generation.</p>
      <div class="document-info">
        <strong>Document:</strong> <span id="deleteDocumentName"></span>
      </div>
      <div class="delete-confirmation">
        <label class="checkbox-container">
          <input type="checkbox" id="deleteConfirmCheck">
          <span class="checkmark"></span>
          I understand this action is permanent and cannot be reversed
        </label>
      </div>
    </div>
    <div class="delete-modal-actions">
      <button type="button" class="cancel-btn" id="cancelDelete">Cancel</button>
      <button type="button" class="delete-btn" id="confirmDelete" disabled>Delete Document</button>
    </div>
  </div>
</dialog>

<!-- Add Client Modal -->
<dialog id="addClientModal" aria-label="Add new client">
  <div class="add-client-modal-content">
    <div class="add-client-modal-header">
      <h3>Add New Client</h3>
      <button type="button" class="modal-close-btn" onclick="closeAddClientModal()">×</button>
    </div>
    <div class="add-client-modal-body">
      <div class="client-name-section">
        <label for="clientNameInput">Client Name</label>
        <input type="text" id="clientNameInput" placeholder="John Smith" autocomplete="off">
        <div class="input-help">Enter the client's full name (first and last)</div>
      </div>
      
      <div class="upload-section">
        <label>Initial Documents (Optional)</label>
        <div class="modal-upload-area">
          <input type="file" class="modal-upload-input" id="clientFileUpload" multiple accept=".pdf,.doc,.docx,.xlsx,.ppt,.pptx">
          <div class="modal-upload-text">
            <div class="upload-icon">📄</div>
            <div>Drop files here or click to upload</div>
            <div class="upload-hint">Upload documents for this client</div>
          </div>
        </div>
        <div id="selectedFilesList" class="selected-files"></div>
      </div>
      
      <div class="processing-info">
        <strong>Note:</strong> After creating the client, it may take 1-2 minutes for uploaded documents to appear in the system while they are being processed.
      </div>
    </div>
    <div class="add-client-modal-actions">
      <button type="button" class="cancel-btn" onclick="closeAddClientModal()">Cancel</button>
      <button type="button" class="create-btn" id="createClientBtn" onclick="createNewClient()">Create Client</button>
    </div>
  </div>
</dialog>

<script>
// Dynamic client data - will be populated from Vertesia
let clientsData = {};

// Document data - starts empty, will be populated by API
let documentsData = [];

let currentClient = null;
let sortOrder = 'desc';
let documentsVisible = true;
let selectedFiles = [];

// Load clients dynamically from Vertesia
async function loadClientsFromVertesia() {
  try {
    console.log('Loading clients from Vertesia...');
    
    const response = await fetch('https://api.vertesia.io/api/v1/objects?limit=1000&offset=0', {
      method: 'GET',
      headers: {
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9',
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`Failed to fetch documents: ${response.status}`);
    }
    
    const documents = await response.json();
    console.log(`Found ${documents.length} documents in Vertesia`);
    
    // Extract unique client names with better logic
    const clientNamesMap = new Map(); // Use Map to track normalized names and pick best version
    
    documents.forEach(doc => {
      let clientName = null;
      
      // Check document properties first
      if (doc.properties && doc.properties.client) {
        clientName = doc.properties.client;
      }
      // Enhanced extraction from document name
      else if (doc.name) {
        // Pattern 1: Standard " - " format
        if (doc.name.includes(' - ')) {
          clientName = doc.name.split(' - ')[0].trim();
        }
        // Pattern 2: Underscore separated (Chris_Lehman_Document.pdf)
        else if (doc.name.includes('_')) {
          const parts = doc.name.split('_');
          if (parts.length >= 2) {
            // Take first two parts as first/last name
            clientName = `${parts[0]} ${parts[1]}`;
          }
        }
        // Pattern 3: Look for common name patterns
        else {
          const nameMatch = doc.name.match(/^([A-Z][a-z]+\s+[A-Z][a-z]+)/);
          if (nameMatch) {
            clientName = nameMatch[1];
          }
        }
      }
      
      // Clean up and validate client name
      if (clientName) {
        // Remove file extensions and clean up
        clientName = clientName.replace(/\.(pdf|docx?|xlsx?|pptx?)$/i, '').trim();
        
        // Only process if it looks like a real name (has at least first and last)
        if (clientName.includes(' ') && clientName.split(' ').length >= 2) {
          
          // Normalize the name for comparison (lowercase, single spaces)
          const normalizedName = clientName.toLowerCase()
            .replace(/\s+/g, ' ')  // Replace multiple spaces with single space
            .trim();
          
          // If we haven't seen this normalized name before, or if this version looks "better"
          if (!clientNamesMap.has(normalizedName)) {
            clientNamesMap.set(normalizedName, clientName);
          } else {
            // Keep the version with proper capitalization if current one is all lowercase
            const existing = clientNamesMap.get(normalizedName);
            if (existing === existing.toLowerCase() && clientName !== clientName.toLowerCase()) {
              clientNamesMap.set(normalizedName, clientName);
            }
          }
        }
      }
    });
    
    // Convert to clientsData format using unique normalized names
    clientsData = {};
    clientNamesMap.forEach((displayName, normalizedName) => {
      const clientId = normalizedName.replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '');
      clientsData[clientId] = { name: displayName };
    });
    
    console.log('Loaded unique clients:', Object.values(clientsData).map(c => c.name));
    
    renderClients();
    
    if (!currentClient || !clientsData[currentClient]) {
      const firstClientId = Object.keys(clientsData)[0];
      if (firstClientId) {
        switchClient(firstClientId);
      }
    } else {
      await loadClientDocuments(currentClient);
    }
    
  } catch (error) {
    console.error('Failed to load clients from Vertesia:', error);
  }
}

// Test Vertesia API function
async function testVertesiaAPI() {
  const testBtn = document.getElementById('testApiBtn');
  testBtn.disabled = true;
  testBtn.textContent = 'Testing...';
  
  try {
    console.log('Making API call to Vertesia...');
    
    const response = await fetch('https://api.vertesia.io/api/v1/objects?limit=100&offset=0', {
      method: 'GET',
      headers: {
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9',
        'Content-Type': 'application/json'
      }
    });
    
    console.log('Response status:', response.status);
    
    if (response.ok) {
      const result = await response.json();
      console.log('API Response:', result);
      console.log('Number of documents:', Array.isArray(result) ? result.length : 'Response is not an array');
      
      alert(`Successfully loaded ${result.length} documents! Check console for details.`);
      
      // Refresh client list after test
      await loadClientsFromVertesia();
      
    } else {
      const errorText = await response.text();
      console.error('API Error Response:', errorText);
      alert(`API call failed with status ${response.status}. Check console for details.`);
    }
  } catch (error) {
    console.error('Network error:', error);
    alert('Network error occurred. Check console for details.');
  } finally {
    testBtn.disabled = false;
    testBtn.textContent = 'Test API Call';
  }
}

function extractClientFromName(docName) {
  if (!docName) return 'all';
  
  for (const [clientId, client] of Object.entries(clientsData)) {
    if (docName.toLowerCase().includes(client.name.toLowerCase())) {
      return clientId;
    }
  }
  return 'all';
}

// AI Profile Functions
function checkClientProfile(clientId) {
  const client = clientsData[clientId];
  if (!client) return false;
  
  // Get client's first and last name parts
  const nameParts = client.name.split(' ');
  const firstName = nameParts[0];
  const lastName = nameParts[1] || '';
  
  // Look for AI profile document with flexible matching
  return documentsData.some(doc => {
    // Must be associated with this client
    if (doc.client !== clientId) return false;
    
    // Convert document name to lowercase for case-insensitive matching
    const docNameLower = doc.name.toLowerCase();
    
    // Check if document contains AI profile indicators
    const hasAIProfile = docNameLower.includes('ai_profile') || 
                        docNameLower.includes('ai profile') ||
                        docNameLower.includes('aiprofile');
    
    // Check if document contains client's name
    const hasClientName = docNameLower.includes(firstName.toLowerCase()) &&
                         (lastName === '' || docNameLower.includes(lastName.toLowerCase()));
    
    return hasAIProfile && hasClientName;
  });
}

function updateProfileStatus() {
  const profileStatus = document.getElementById('profileStatus');
  
  if (!currentClient || !clientsData[currentClient]) {
    profileStatus.innerHTML = `
      <div class="profile-needed">
        <span class="status-light red"></span>
        <span>No client selected</span>
      </div>
    `;
    return;
  }
  
  const hasProfile = checkClientProfile(currentClient);
  
  if (hasProfile) {
    profileStatus.innerHTML = `
      <div class="profile-complete">
        <span class="status-light green"></span>
        <span>AI Profile Complete</span>
      </div>
    `;
  } else {
    profileStatus.innerHTML = `
      <div class="profile-needed">
        <span class="status-light red"></span>
        <span>AI Profile Required - Generate before creating documents</span>
        <button class="generate-profile-btn" onclick="generateAIProfile()">
          Generate AI Profile
        </button>
      </div>
    `;
  }
}

async function generateAIProfile() {
  if (!currentClient || !clientsData[currentClient]) {
    alert('Please select a client first');
    return;
  }

  const profileBtn = document.querySelector('.generate-profile-btn');
  if (profileBtn) {
    profileBtn.disabled = true;
    profileBtn.textContent = 'Generating...';
  }

  // Add to queue
  documentQueue.addGeneration('AI Profile', currentClient);

  try {
    await fetch('https://api.vertesia.io/api/v1/execute/async', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9'
      },
      body: JSON.stringify({
        "type": "conversation",
        "interaction": "TESTFinancialProfileGenerator",
        "data": {
          "task": `For ${clientsData[currentClient].name} create an AI Profile`
        },
        "config": {
          "environment": "681915c6a01fb262a410c161",
          "model": "publishers/anthropic/models/claude-3-7-sonnet"
        }
      })
    });
    
    console.log(`AI Profile generation started for ${clientsData[currentClient].name}`);
  } catch (error) {
    console.error('AI Profile generation error:', error);
    alert('Failed to generate AI Profile. Please try again.');
  } finally {
    if (profileBtn) {
      profileBtn.disabled = false;
      profileBtn.textContent = 'Generate AI Profile';
    }
  }
}

// Document Queue Class
class DocumentQueue {
  constructor() {
    this.activeGenerations = new Map();
    this.timers = new Map();
  }
  
  addGeneration(docType, clientId) {
    const id = Date.now() + Math.random();
    const generation = {
      id,
      docType,
      clientId,
      clientName: clientsData[clientId].name,
      startTime: Date.now(),
      estimatedDuration: 5 * 60 * 1000
    };
    
    this.activeGenerations.set(id, generation);
    this.startTimer(id);
    this.updateQueueDisplay();
    return id;
  }
  
  startTimer(id) {
    const timer = setInterval(() => {
      const generation = this.activeGenerations.get(id);
      if (!generation) {
        clearInterval(timer);
        return;
      }
      
      const elapsed = Date.now() - generation.startTime;
      if (elapsed >= generation.estimatedDuration) {
        this.completeGeneration(id);
      }
      this.updateQueueDisplay();
    }, 1000);
    
    this.timers.set(id, timer);
  }
  
  completeGeneration(id) {
    const generation = this.activeGenerations.get(id);
    if (generation) {
      const newDoc = {
        id: Date.now(),
        name: generation.docType,
        date: new Date().toISOString().split('T')[0],
        client: generation.clientId,
        type: 'generated'
      };
      
      documentsData.unshift(newDoc);
      if (generation.clientId === currentClient) {
        renderDocuments();
        updateProfileStatus(); // Update profile status after document completion
      }
    }
    
    this.removeGeneration(id);
  }
  
  removeGeneration(id) {
    clearInterval(this.timers.get(id));
    this.timers.delete(id);
    this.activeGenerations.delete(id);
    this.updateQueueDisplay();
  }
  
  updateQueueDisplay() {
    const itemsElement = document.getElementById('queueItems');
    itemsElement.innerHTML = '';
    
    this.activeGenerations.forEach(generation => {
      const elapsed = Date.now() - generation.startTime;
      const remaining = Math.max(0, generation.estimatedDuration - elapsed);
      const minutes = Math.floor(remaining / 60000);
      const seconds = Math.floor((remaining % 60000) / 1000);
      
      const div = document.createElement('div');
      div.className = 'queue-item';
      div.innerHTML = `
        <div class="spinner"></div>
        <div class="queue-item-content">
          <div class="queue-item-name">${generation.docType}</div>
          <div class="queue-item-client">${generation.clientName}</div>
        </div>
        <span class="queue-timer">${minutes}:${seconds.toString().padStart(2, '0')}</span>
        <button class="queue-cancel" onclick="documentQueue.removeGeneration(${generation.id})">✕</button>
      `;
      itemsElement.appendChild(div);
    });
  }
}

const documentQueue = new DocumentQueue();

// Viewer Functions
function openFormattedViewer(markdownContent, title) {
  const dlg = document.getElementById('viewer');
  document.getElementById('viewerTitle').textContent = title;
  
  // Convert markdown to HTML
  const htmlContent = marked.parse(markdownContent);
  
  // Replace iframe with formatted content div
  const viewerFrame = document.getElementById('viewerFrame');
  viewerFrame.outerHTML = `<div id="viewerFrame" class="viewer-content">${htmlContent}</div>`;
  
  dlg.showModal();
}

function closeViewer() {
  const dlg = document.getElementById('viewer');
  const viewerFrame = document.getElementById('viewerFrame');
  
  // Reset to iframe structure for next use
  viewerFrame.outerHTML = '<iframe id="viewerFrame"></iframe>';
  
  if (dlg?.open) dlg.close();
}

// Add a regular viewer function for PDFs/Office docs
function openViewer(url, title) {
  const dlg = document.getElementById('viewer');
  document.getElementById('viewerTitle').textContent = title || 'Document';
  document.getElementById('viewerFrame').src = url;
  dlg.showModal();
}

// Initialize
async function init() {
  // Load clients from Vertesia first
  await loadClientsFromVertesia();
  
  // Initialize viewer
  document.getElementById('closeViewer').addEventListener('click', closeViewer);
  
  document.getElementById('viewer').addEventListener('click', (e) => {
    const r = e.target.getBoundingClientRect();
    const outside = e.clientX < r.left || e.clientX > r.right || e.clientY < r.top || e.clientY > r.bottom;
    if (outside) closeViewer();
  });
  
  // Initialize delete modal
  document.getElementById('cancelDelete').addEventListener('click', cancelDocumentDelete);
  document.getElementById('confirmDelete').addEventListener('click', confirmDocumentDelete);
  
  // Checkbox validation for delete button
  document.getElementById('deleteConfirmCheck').addEventListener('change', function() {
    document.getElementById('confirmDelete').disabled = !this.checked;
  });
  
  // Add client modal file handling
  document.getElementById('clientFileUpload').addEventListener('change', function(event) {
    const files = Array.from(event.target.files);
    selectedFiles = [...selectedFiles, ...files];
    updateSelectedFilesList();
    event.target.value = '';
  });
  
  // Escape key handling
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && document.getElementById('viewer').open) closeViewer();
    if (e.key === 'Escape' && document.getElementById('deleteModal').open) cancelDocumentDelete();
    if (e.key === 'Escape' && document.getElementById('addClientModal').open) closeAddClientModal();
  });
}

// Render client list
function renderClients() {
  const clientList = document.getElementById('clientList');
  clientList.innerHTML = '';
  
  if (Object.keys(clientsData).length === 0) {
    const emptyDiv = document.createElement('div');
    emptyDiv.className = 'empty-state';
    emptyDiv.textContent = 'No clients found. Add a client to get started.';
    clientList.appendChild(emptyDiv);
    return;
  }
  
  // Sort clients alphabetically by last name, then first name
  const sortedClients = Object.entries(clientsData).sort((a, b) => {
    const namePartsA = a[1].name.split(' ');
    const namePartsB = b[1].name.split(' ');
    
    const lastNameA = namePartsA[namePartsA.length - 1]; // Get last part as last name
    const lastNameB = namePartsB[namePartsB.length - 1];
    
    // First sort by last name
    const lastNameCompare = lastNameA.localeCompare(lastNameB);
    if (lastNameCompare !== 0) return lastNameCompare;
    
    // If last names are the same, sort by first name
    const firstNameA = namePartsA[0];
    const firstNameB = namePartsB[0];
    return firstNameA.localeCompare(firstNameB);
  });
  
  sortedClients.forEach(([clientId, client]) => {
    const div = document.createElement('div');
    div.className = `client-item ${clientId === currentClient ? 'active' : ''}`;
    
    // Convert "First Last" to "Last, First"
    const nameParts = client.name.split(' ');
    const firstName = nameParts[0];
    const lastName = nameParts[nameParts.length - 1];
    const displayName = `${lastName}, ${firstName}`;
    
    div.textContent = displayName;
    div.onclick = () => switchClient(clientId);
    clientList.appendChild(div);
  });
}

// Switch client
async function switchClient(clientId) {
  currentClient = clientId;
  const client = clientsData[clientId];
  
  if (!client) return;
  
  // Update UI
  document.getElementById('documentsHeader').textContent = `${client.name} Documents`;
  renderClients();
  
  // Load documents for this specific client
  await loadClientDocuments(clientId);
  
  // Update profile status after loading documents
  updateProfileStatus();
}

async function loadClientDocuments(clientId) {
  const client = clientsData[clientId];
  
  if (!client) return;
  
  try {
    // Search for documents containing this client's name
    const response = await fetch(`https://api.vertesia.io/api/v1/objects?name=${encodeURIComponent(client.name)}&limit=50`, {
      method: 'GET',
      headers: {
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9',
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      const result = await response.json();
      
      // Convert to our format and assign to current client
      documentsData = result.map(doc => ({
        id: doc.id,
        name: doc.name,
        date: doc.created_at || doc.updated_at,
        client: clientId,
        type: 'vertesia',
        vertesiaId: doc.id
      }));
      
      renderDocuments();
    }
  } catch (error) {
    console.error('Failed to load client documents:', error);
  }
}

// Add Client Functions
function openAddClientModal() {
  document.getElementById('addClientModal').showModal();
  document.getElementById('clientNameInput').focus();
  selectedFiles = [];
  updateSelectedFilesList();
}

function closeAddClientModal() {
  document.getElementById('addClientModal').close();
  document.getElementById('clientNameInput').value = '';
  selectedFiles = [];
  updateSelectedFilesList();
}

function updateSelectedFilesList() {
  const filesList = document.getElementById('selectedFilesList');
  filesList.innerHTML = '';
  
  selectedFiles.forEach((file, index) => {
    const fileItem = document.createElement('div');
    fileItem.className = 'file-item';
    fileItem.innerHTML = `
      <span>${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
      <button type="button" class="file-remove" onclick="removeFile(${index})">Remove</button>
    `;
    filesList.appendChild(fileItem);
  });
}

function removeFile(index) {
  selectedFiles.splice(index, 1);
  updateSelectedFilesList();
}

async function createNewClient() {
  const clientName = document.getElementById('clientNameInput').value.trim();
  
  if (!clientName) {
    alert('Please enter a client name');
    return;
  }
  
  if (clientName.split(' ').length < 2) {
    alert('Please enter both first and last name');
    return;
  }
  
  // Check if client already exists
  const existingClient = Object.values(clientsData).find(
    client => client.name.toLowerCase() === clientName.toLowerCase()
  );
  
  if (existingClient) {
    alert('A client with this name already exists');
    return;
  }
  
  const createBtn = document.getElementById('createClientBtn');
  createBtn.disabled = true;
  createBtn.textContent = 'Creating...';
  
  try {
    // Upload files if any were selected
    if (selectedFiles.length > 0) {
      createBtn.textContent = 'Uploading documents...';
      
      for (const file of selectedFiles) {
        const fileName = `${clientName} - ${file.name}`;
        
        try {
          // Step 1: Get upload URL from Vertesia
          const urlResponse = await fetch('https://api.vertesia.io/api/v1/objects/upload-url', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9'
            },
            body: JSON.stringify({
              "name": fileName,
              "mime_type": file.type || "application/pdf"
            })
          });
          
          if (!urlResponse.ok) {
            throw new Error(`Failed to get upload URL: ${urlResponse.status}`);
          }
          
          const uploadData = await urlResponse.json();
          
          // Step 2: Upload to Google Cloud Storage
          const fileUploadResponse = await fetch(uploadData.url, {
            method: 'PUT',
            body: file
          });
          
          if (!fileUploadResponse.ok) {
            throw new Error(`Failed to upload file: ${fileUploadResponse.status}`);
          }
          
          // Step 3: Create the content object in Vertesia
          const createObjectResponse = await fetch('https://api.vertesia.io/api/v1/objects', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9'
            },
            body: JSON.stringify({
              "name": fileName,
              "description": `Document uploaded for ${clientName}`,
              "content": {
                "source": `gs://store_prod_dd0d3a_2ca798/${uploadData.id}`,
                "type": file.type || "application/pdf",
                "name": file.name
              },
              "properties": {
                "client": clientName, // This ensures the client will be discovered
                "uploaded_at": new Date().toISOString()
              }
            })
          });
          
          if (!createObjectResponse.ok) {
            throw new Error(`Failed to create object: ${createObjectResponse.status}`);
          }
          
        } catch (error) {
          console.error(`Failed to upload ${file.name}:`, error);
        }
      }
    } else {
      // If no files uploaded, add the client manually to our local list
      const clientId = clientName.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '');
      clientsData[clientId] = { name: clientName };
    }
    
    // Reload clients from Vertesia to pick up the new client
    createBtn.textContent = 'Refreshing...';
    await loadClientsFromVertesia();
    
    // Switch to the new client
    const clientId = clientName.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '');
    if (clientsData[clientId]) {
      switchClient(clientId);
    }
    
    // Close modal
    closeAddClientModal();
    
    // Show success message
    const fileCount = selectedFiles.length;
    let message = `Client "${clientName}" created successfully!`;
    if (fileCount > 0) {
      message += ` ${fileCount} document(s) uploaded and are being processed.`;
    }
    alert(message);
    
  } catch (error) {
    console.error('Error creating client:', error);
    alert(`Failed to create client: ${error.message}`);
  } finally {
    createBtn.disabled = false;
    createBtn.textContent = 'Create Client';
  }
}

// File upload
async function handleFileUpload(event) {
  const files = event.target.files;
  if (files.length === 0) return;
  
  if (!currentClient || !clientsData[currentClient]) {
    alert('Please select a client first');
    return;
  }
  
  const uploadArea = document.querySelector('.upload-area');
  uploadArea.style.background = '#fff3f6';
  uploadArea.style.borderColor = '#8B1538';
  
  try {
    for (const file of files) {
      const clientName = clientsData[currentClient].name;
      const fileName = `${clientName} - ${file.name}`;
      
      console.log(`Step 1: Getting upload URL for: ${fileName}`);
      
      // Step 1: Get upload URL from Vertesia
      const urlResponse = await fetch('https://api.vertesia.io/api/v1/objects/upload-url', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9'
        },
        body: JSON.stringify({
          "name": fileName,
          "mime_type": file.type || "application/pdf"
        })
      });
      
      if (!urlResponse.ok) {
        throw new Error(`Failed to get upload URL: ${urlResponse.status}`);
      }
      
      const uploadData = await urlResponse.json();
      console.log('Step 1 complete. Upload data:', uploadData);
      
      // Step 2: Upload to Google Cloud Storage
      console.log(`Step 2: Uploading ${file.size} bytes to GCS...`);
      
      const fileUploadResponse = await fetch(uploadData.url, {
        method: 'PUT',
        body: file
      });
      
      console.log('Upload response status:', fileUploadResponse.status);
      
      if (!fileUploadResponse.ok) {
        const errorText = await fileUploadResponse.text();
        console.error('Upload error response:', errorText);
        throw new Error(`Failed to upload file: ${fileUploadResponse.status}`);
      }
      
      console.log('Step 2 complete - file uploaded to GCS');
      
      // Step 3: Create the content object in Vertesia
      console.log('Step 3: Creating content object in Vertesia...');
      
      const createObjectResponse = await fetch('https://api.vertesia.io/api/v1/objects', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9'
        },
        body: JSON.stringify({
          "name": fileName,
          "description": `Document uploaded for ${clientName}`,
          "content": {
            "source": `gs://store_prod_dd0d3a_2ca798/${uploadData.id}`, // Using the ID from step 1
            "type": file.type || "application/pdf",
            "name": file.name
          },
          "properties": {
            "client": clientName,
            "uploaded_at": new Date().toISOString()
          }
        })
      });
      
      if (!createObjectResponse.ok) {
        const errorText = await createObjectResponse.text();
        console.error('Create object error:', errorText);
        throw new Error(`Failed to create object: ${createObjectResponse.status}`);
      }
      
      const createdObject = await createObjectResponse.json();
      console.log('Step 3 complete - object created:', createdObject);
    }
    
    // Refresh the document list
    setTimeout(() => loadClientDocuments(currentClient), 1000);
    alert(`Successfully uploaded ${files.length} file(s)`);
    
  } catch (error) {
    console.error('Upload error:', error);
    alert(`Upload failed: ${error.message}`);
  } finally {
    setTimeout(() => {
      uploadArea.style.background = '';
      uploadArea.style.borderColor = '';
    }, 1000);
    event.target.value = '';
  }
}

// Generate document - Updated with AI Profile check
async function generateDocument() {
  if (!currentClient || !clientsData[currentClient]) {
    alert('Please select a client first');
    return;
  }
  
  // Check if client has AI profile before generating documents
  if (!checkClientProfile(currentClient)) {
    alert('Please generate an AI Profile for this client first before creating other documents.');
    return;
  }
  
  const select = document.getElementById('docTypeSelect');
  const selectedDocType = select.value;
  
  if (!selectedDocType) {
    alert('Please select a document type');
    return;
  }
  
  // Add to queue with the captured value
  documentQueue.addGeneration(selectedDocType, currentClient);
  
  // Now reset the select
  select.value = '';
  
  try {
    await fetch('https://api.vertesia.io/api/v1/execute/async', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9'
      },
      body: JSON.stringify({
        "type": "conversation",
        "interaction": "AdvisorAssistant@2",
        "data": {
          "task": `For ${clientsData[currentClient].name} create a ${selectedDocType} document`
        },
        "config": {
          "environment": "681915c6a01fb262a410c161",
          "model": "publishers/anthropic/models/claude-3-7-sonnet"
        }
      })
    });
    
    console.log(`Document generation started: ${selectedDocType} for ${clientsData[currentClient].name}`);
  } catch (error) {
    console.error('API error:', error);
  }
}

// Search documents
function searchDocuments() {
  const query = document.getElementById('searchBar').value.toLowerCase();
  renderDocuments(query);
}

// Sort documents
function sortDocuments() {
  sortOrder = sortOrder === 'desc' ? 'asc' : 'desc';
  renderDocuments();
}

// Toggle documents
function toggleDocuments() {
  documentsVisible = !documentsVisible;
  const docItems = document.querySelectorAll('.doc-item');
  docItems.forEach(item => {
    item.style.display = documentsVisible ? 'flex' : 'none';
  });
}

// Render documents - Updated with profile status check
function renderDocuments(searchQuery = '') {
  const docsList = document.getElementById('documentsList');
  docsList.innerHTML = '';
  
  // Update profile status first
  updateProfileStatus();
  
  let filteredDocs = documentsData.filter(doc => 
    (doc.client === currentClient || doc.client === 'all') &&
    (searchQuery === '' || doc.name.toLowerCase().includes(searchQuery))
  );
  
  if (filteredDocs.length === 0) {
    const emptyDiv = document.createElement('div');
    emptyDiv.className = 'empty-state';
    emptyDiv.textContent = 'No documents found. Try uploading files or generating new documents.';
    docsList.appendChild(emptyDiv);
    return;
  }
  
  filteredDocs.sort((a, b) => {
    const dateA = new Date(a.date);
    const dateB = new Date(b.date);
    return sortOrder === 'desc' ? dateB - dateA : dateA - dateB;
  });
  
  filteredDocs.forEach((doc, index) => {
    const div = document.createElement('div');
    div.className = 'doc-item';
    div.innerHTML = `
      <div class="doc-info">
        <div class="doc-name">${doc.name}</div>
        <div class="doc-date">${doc.date}</div>
      </div>
      <div class="doc-actions">
        <span class="doc-action" onclick="viewDocument('${doc.id}')">view</span>
        <span class="doc-action" onclick="downloadDocument('${doc.id}')">download</span>
        <span class="doc-action" onclick="deleteDocument('${doc.id}')">delete</span>
      </div>
    `;
    docsList.appendChild(div);
  });
}

// Document actions
async function viewDocument(id) {
  const doc = documentsData.find(d => d.id === id);
  
  if (!doc || !doc.vertesiaId) {
    alert('Cannot view this document - missing ID');
    return;
  }
  
  try {
    console.log(`Getting object details for ${doc.vertesiaId}...`);
    const objectResponse = await fetch(`https://api.vertesia.io/api/v1/objects/${doc.vertesiaId}`, {
      headers: { 
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9' 
      }
    });
    
    if (!objectResponse.ok) {
      throw new Error(`Failed to get object: ${objectResponse.status}`);
    }
    
    const objectData = await objectResponse.json();
    
    // Debug logging to see what Vertesia is returning
    console.log('Full object data:', objectData);
    console.log('Content type:', objectData.content?.type);
    console.log('Document name:', doc.name);
    
    const fileUri = objectData.content?.source;
    if (!fileUri) {
      throw new Error('No file source found in object');
    }
    
    // Get the download URL
    const downloadResponse = await fetch('https://api.vertesia.io/api/v1/objects/download-url', {
      method: 'POST',
      headers: { 
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ "file": fileUri })
    });
    
    if (!downloadResponse.ok) {
      throw new Error(`Failed to get download URL: ${downloadResponse.status}`);
    }
    
    const downloadData = await downloadResponse.json();
    
    // Fetch the content to see what we actually get
    const contentResponse = await fetch(downloadData.url);
    const contentType = contentResponse.headers.get('content-type');
    console.log('Actual content type from URL:', contentType);
    
    // Check if it's text-based content (markdown, HTML, plain text)
    if (contentType?.includes('text/') || 
        objectData.content?.type === 'text/markdown' ||
        objectData.content?.type?.includes('text/')) {
      
      const textContent = await contentResponse.text();
      console.log('Text content preview:', textContent.substring(0, 500));
      
      // Try to determine if it's markdown
      if (textContent.includes('# ') || textContent.includes('## ') || 
          objectData.content?.type === 'text/markdown') {
        console.log('Treating as markdown');
        openFormattedViewer(textContent, doc.name);
      } else {
        console.log('Treating as plain text/HTML');
        // Display as plain text or HTML
        const dlg = document.getElementById('viewer');
        document.getElementById('viewerTitle').textContent = doc.name;
        const viewerFrame = document.getElementById('viewerFrame');
        viewerFrame.outerHTML = `<div id="viewerFrame" class="viewer-content"><pre style="white-space: pre-wrap; font-family: inherit;">${textContent}</pre></div>`;
        dlg.showModal();
      }
      
    } else {
      console.log('Treating as binary file, opening in iframe');
      // For PDFs and other binary files
      openViewer(downloadData.url, doc.name);
    }
    
  } catch (error) {
    console.error('View document error:', error);
    alert(`Failed to view document: ${error.message}`);
  }
}

async function downloadDocument(id) {
  const doc = documentsData.find(d => d.id === id);
  
  if (!doc || !doc.vertesiaId) {
    alert('Cannot download this document - missing ID');
    return;
  }
  
  try {
    console.log(`Getting object details for download: ${doc.vertesiaId}...`);
    const objectResponse = await fetch(`https://api.vertesia.io/api/v1/objects/${doc.vertesiaId}`, {
      headers: { 
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9' 
      }
    });
    
    if (!objectResponse.ok) {
      throw new Error(`Failed to get object: ${objectResponse.status}`);
    }
    
    const objectData = await objectResponse.json();
    const fileUri = objectData.content?.source;
    
    if (!fileUri) {
      throw new Error('No file source found in object');
    }
    
    console.log('Getting signed download URL...');
    let downloadResponse = await fetch('https://api.vertesia.io/api/v1/objects/download-url', {
      method: 'POST',
      headers: { 
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ 
        "file": fileUri,
        "format": "original"
      })
    });
    
    if (!downloadResponse.ok) {
      console.log('Format parameter failed, trying without format...');
      downloadResponse = await fetch('https://api.vertesia.io/api/v1/objects/download-url', {
        method: 'POST',
        headers: { 
          'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 
          "file": fileUri
        })
      });
    }
    
    if (!downloadResponse.ok) {
      throw new Error(`Failed to get download URL: ${downloadResponse.status}`);
    }
    
    const downloadData = await downloadResponse.json();
    
    // Fetch the markdown content
    console.log('Downloading and formatting content...');
    const textResponse = await fetch(downloadData.url);
    const markdownContent = await textResponse.text();
    
    // Convert to formatted HTML
    const htmlContent = marked.parse(markdownContent);
    
    // Create a temporary div with the formatted content
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlContent;
    tempDiv.style.cssText = `
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      color: #1f2d3d;
      max-width: 900px;
      margin: 0 auto;
      padding: 30px 40px;
    `;
    
    // Apply styling to elements
    tempDiv.querySelectorAll('h1').forEach(h1 => {
      h1.style.cssText = `
        font-size: 28px;
        color: #8B1538;
        border-bottom: 3px solid #8B1538;
        padding-bottom: 12px;
        margin: 30px 0 20px 0;
        font-weight: 700;
      `;
    });
    
    tempDiv.querySelectorAll('h2').forEach(h2 => {
      h2.style.cssText = `
        font-size: 22px;
        color: #1f2d3d;
        margin: 25px 0 15px 0;
        font-weight: 600;
        border-left: 4px solid #8B1538;
        padding-left: 12px;
      `;
    });
    
    tempDiv.querySelectorAll('h3').forEach(h3 => {
      h3.style.cssText = `
        font-size: 18px;
        color: #1f2d3d;
        margin: 20px 0 12px 0;
        font-weight: 600;
      `;
    });
    
    tempDiv.querySelectorAll('p').forEach(p => {
      p.style.cssText = 'margin-bottom: 16px; text-align: justify;';
    });
    
    tempDiv.querySelectorAll('strong').forEach(strong => {
      strong.style.cssText = 'color: #8B1538; font-weight: 600;';
    });
    
    tempDiv.querySelectorAll('table').forEach(table => {
      table.style.cssText = `
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        font-size: 14px;
      `;
      
      table.querySelectorAll('th').forEach(th => {
        th.style.cssText = `
          background-color: #f8f9fb;
          border: 1px solid #e0e5ea;
          padding: 12px 8px;
          text-align: left;
          font-weight: 600;
        `;
      });
      
      table.querySelectorAll('td').forEach(td => {
        td.style.cssText = `
          border: 1px solid #e0e5ea;
          padding: 10px 8px;
          text-align: left;
        `;
      });
    });
    
    // Add to body temporarily for PDF generation
    document.body.appendChild(tempDiv);
    
    // Configure PDF options
    const opt = {
      margin: 0.5,
      filename: doc.name.replace(/\.[^/.]+$/, '') + '.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };
    
    // Generate and download PDF
    try {
      await html2pdf().set(opt).from(tempDiv).save();
      console.log(`PDF download completed: ${doc.name}`);
    } finally {
      // Clean up - remove the temporary div
      document.body.removeChild(tempDiv);
    }
    
  } catch (error) {
    console.error('Download document error:', error);
    alert(`Failed to download document: ${error.message}`);
  }
}

// Delete Functions
let documentToDelete = null;

function deleteDocument(id) {
  const doc = documentsData.find(d => d.id === id);
  if (!doc) {
    alert('Document not found');
    return;
  }
  
  documentToDelete = doc;
  
  // Update the modal with document info
  document.getElementById('deleteDocumentName').textContent = doc.name;
  
  // Reset checkbox and button state
  const checkbox = document.getElementById('deleteConfirmCheck');
  const deleteBtn = document.getElementById('confirmDelete');
  checkbox.checked = false;
  deleteBtn.disabled = true;
  
  // Show the modal
  document.getElementById('deleteModal').showModal();
}

async function confirmDocumentDelete() {
  if (!documentToDelete) return;
  
  try {
    console.log(`Deleting document: ${documentToDelete.vertesiaId}`);
    
    // Make DELETE request to Vertesia API
    const response = await fetch(`https://api.vertesia.io/api/v1/objects/${documentToDelete.vertesiaId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': 'Bearer sk-544583102491bf69b0351418bbdd2aa9'
      }
    });
    
    if (!response.ok) {
      throw new Error(`Failed to delete document: ${response.status}`);
    }
    
    const result = await response.json();
    console.log('Delete result:', result);
    
    // Remove from local array
    documentsData = documentsData.filter(d => d.id !== documentToDelete.id);
    
    // Re-render the document list and update profile status
    renderDocuments();
    updateProfileStatus();
    
    // Close modal and reset
    document.getElementById('deleteModal').close();
    documentToDelete = null;
    
    console.log(`Document deleted successfully`);
    
  } catch (error) {
    console.error('Delete document error:', error);
    alert(`Failed to delete document: ${error.message}`);
  }
}

function cancelDocumentDelete() {
  document.getElementById('deleteModal').close();
  documentToDelete = null;
}

// Initialize on page load
window.onload = init;
</script>

</body>
</html>
